generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
   url      = env("DATABASE_URL")
}

/**
 * ===================== USERS =====================
 */

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(PLAYER)
  createdAt DateTime @default(now())

  player Player?

  accounts Account[]
  sessions Session[]
}

/**
 * ===================== PLAYER =====================
 */

model Player {
  id         String    @id @default(cuid())
  rollNumber String    @unique
  name       String
  email      String    @unique
  department String
  dob        DateTime?
  createdAt  DateTime  @default(now())

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  sports         PlayerSport[]
  rosters        TeamRoster[]
  auctionPools   AuctionPlayerPool[]
  bidEvents      BidEvent[]
  auctionResults AuctionResult[]
  matchLineups   MatchLineup[]
  matchEvents    MatchEvent[]
}

/**
 * ===================== PLAYER SPORT =====================
 */

model PlayerSport {
  id       String @id @default(cuid())
  playerId String
  sport    Sport

  player Player @relation(fields: [playerId], references: [id])

  @@unique([playerId, sport])
}

/**
 * ===================== TOURNAMENT =====================
 */

model Tournament {
  id        String           @id @default(cuid())
  name      String
  sport     Sport
  startDate DateTime
  endDate   DateTime
  status    TournamentStatus @default(UPCOMING)
  createdAt DateTime         @default(now())

  teams   Team[]
  matches Match[]
  auction Auction?
}

/**
 * ===================== TEAM =====================
 */

model Team {
  id           String   @id @default(cuid())
  name         String
  sport        Sport
  budget       Int
  tournamentId String
  createdAt    DateTime @default(now())

  tournament Tournament @relation(fields: [tournamentId], references: [id])

  roster         TeamRoster[]
  bidEvents      BidEvent[]
  auctionResults AuctionResult[]
  matchLineups   MatchLineup[]

  matchA Match[] @relation("TeamA")
  matchB Match[] @relation("TeamB")
}

/**
 * ===================== TEAM ROSTER =====================
 */

model TeamRoster {
  id        String  @id @default(cuid())
  teamId    String
  playerId  String
  role      String?
  isCaptain Boolean @default(false)

  team   Team   @relation(fields: [teamId], references: [id])
  player Player @relation(fields: [playerId], references: [id])

  @@unique([teamId, playerId])
}

/**
 * ===================== AUCTION =====================
 */

model Auction {
  id            String        @id @default(cuid())
  tournamentId  String        @unique
  status        AuctionStatus @default(SCHEDULED)
  budgetPerTeam Int
  createdAt     DateTime      @default(now())

  tournament Tournament          @relation(fields: [tournamentId], references: [id])
  playerPool AuctionPlayerPool[]
  bids       BidEvent[]
  results    AuctionResult[]
}

model AuctionPlayerPool {
  id        String @id @default(cuid())
  auctionId String
  playerId  String
  basePrice Int

  auction Auction @relation(fields: [auctionId], references: [id])
  player  Player  @relation(fields: [playerId], references: [id])

  @@unique([auctionId, playerId])
}

model BidEvent {
  id        String   @id @default(cuid())
  auctionId String
  playerId  String
  teamId    String
  amount    Int
  timestamp DateTime @default(now())

  auction Auction @relation(fields: [auctionId], references: [id])
  player  Player  @relation(fields: [playerId], references: [id])
  team    Team    @relation(fields: [teamId], references: [id])
}

model AuctionResult {
  id        String @id @default(cuid())
  auctionId String
  playerId  String
  teamId    String
  soldPrice Int

  auction Auction @relation(fields: [auctionId], references: [id])
  player  Player  @relation(fields: [playerId], references: [id])
  team    Team    @relation(fields: [teamId], references: [id])

  @@unique([auctionId, playerId])
}

/**
 * ===================== MATCH =====================
 */

model Match {
  id           String      @id @default(cuid())
  tournamentId String
  sport        Sport
  teamAId      String
  teamBId      String
  date         DateTime
  venue        String?
  status       MatchStatus @default(SCHEDULED)

  tournament Tournament @relation(fields: [tournamentId], references: [id])
  teamA      Team       @relation("TeamA", fields: [teamAId], references: [id])
  teamB      Team       @relation("TeamB", fields: [teamBId], references: [id])

  lineups MatchLineup[]
  events  MatchEvent[]
}

model MatchLineup {
  id       String  @id @default(cuid())
  matchId  String
  teamId   String
  playerId String
  position String?

  match  Match  @relation(fields: [matchId], references: [id])
  team   Team   @relation(fields: [teamId], references: [id])
  player Player @relation(fields: [playerId], references: [id])
}

model MatchEvent {
  id        String   @id @default(cuid())
  matchId   String
  playerId  String?
  sport     Sport
  eventType String
  payload   Json
  timestamp DateTime @default(now())

  match  Match   @relation(fields: [matchId], references: [id])
  player Player? @relation(fields: [playerId], references: [id])
}

/**
 * ===================== ENUMS =====================
 */

enum Role {
  ADMIN
  COACH
  CAPTAIN
  PLAYER
  SCORER
}

enum Sport {
  CRICKET
  FOOTBALL
  VOLLEYBALL
  BADMINTON
  TABLE_TENNIS
}

enum TournamentStatus {
  UPCOMING
  LIVE
  COMPLETED
}

enum AuctionStatus {
  SCHEDULED
  LIVE
  COMPLETED
}

enum MatchStatus {
  SCHEDULED
  LIVE
  COMPLETED
}

/**
 * ===================== NEXTAUTH =====================
 */

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  access_token      String?
  refresh_token     String?
  expires_at        Int?
  id_token          String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
